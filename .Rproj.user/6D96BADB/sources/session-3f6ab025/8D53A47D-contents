---
title: "BIOL 343: Assignment 9"
date: "Last compiled on `r format(Sys.time(), '%A, %B %d, %Y at %H:%M %Z')`"
author: "Abhay Katoch: 20261644; Matteo Ienis: 20270101; Yudong Zhang: 20345353;"
output:
  html_document: default
---
### Set-Up

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, "Loading Libraries", message = FALSE}
library(tidyverse)
library(magrittr)
library(ggpubr)
library(ggfortify)
library(ggtext)
library(lmtest)
library(MuMIn)
library(MASS)
```

```{r "Loading Data", message = FALSE}
data <- read_csv("~/Documents/School/BIOL343/Assignment_8/05_plant_diverse_island_F2020.csv")
```

Here, we loaded the dataset and code from Assignment 8 to generate the `data.frame` object. Since we determined previously that there were no issues with the data, we have proceeded with the analysis without checking the data again—to avoid repetition. 

```{r, "Removing Features"}
mutated_data <- data %>%
  mutate(
    log_area = log(area + 1),
    log_elev = log(elev + 1),
    log_years_isol = log(years.isol + 1),
    log_years_deglac = log(years.deglac + 1)
  ) %>%
  dplyr::select(
    Island, 
    log_area, 
    latitude, 
    log_elev, 
    log_years_isol, 
    log_years_deglac, 
    ntv.rich, 
    nonntv.rich, 
    dist.mnland
  )
```


Here, we create the models we used Assignment 8.

```{r, "Creating Models"}
native_mod <- lm(ntv.rich ~ log_area + log_elev + dist.mnland, data = mutated_data)
non_native_mod <- lm(nonntv.rich ~ log_area + log_elev + dist.mnland, data = mutated_data)
```

### Question 12

**Perform a manual backwards selection. Start with the full model and eliminate one predictor at a time chosen as the predictor with the highest P value from an analysis.**

```{r, "Performing Manual Backwards Selection on Native Model"}
summary(native_mod)

# Creating successive models with predictors removed. 
## summary(native_mod) determined that log_elev had the highest p-value.
## We remove log_elev for native_mod_2.
native_mod_2 <- lm(ntv.rich ~ log_area + dist.mnland, data = mutated_data)
summary(native_mod_2)

## summary(native_mod_2) determined that dist.mnland had the highest p-value.
## We remove dist.mnland for native_mod_3.
native_mod_3 <- lm(ntv.rich ~ log_area, data = mutated_data)
summary(native_mod_3)

```

Here, we perform the same analysis on the non-native model.

```{r, "Performing Manual Backwards Selection on Non-Native Model"}
summary(non_native_mod)

# Creating successive models with predictors removed. 
## summary(non_native_mod) determined that log_elev had the highest p-value.
## We remove log_elev for non_native_mod_2.
non_native_mod_2 <- lm(nonntv.rich ~ log_area  + dist.mnland, data = mutated_data)
summary(native_mod_2)

## summary(non_native_mod_2) determined that dist.mnland had the highest p-value.
## We remove dist.mnland for non_native_mod_3.
non_native_mod_3 <- lm(nonntv.rich ~ log_area, data = mutated_data)
summary(non_native_mod_3)
```


**Determine the fit of each model using the methods covered in the self-tutorial. Report the adjusted R2 and AIC for each model.** 

```{r, "Determining Fit"}
anova(native_mod, native_mod_2, native_mod_3)
anova(non_native_mod, non_native_mod_2, non_native_mod_3)
```

```{r, "Determining AIC"}
AIC(native_mod)
AIC(native_mod_2)
AIC(native_mod_3)

AIC(non_native_mod)
AIC(non_native_mod_2)
AIC(non_native_mod_3)
```

**You should then validate your results using `stepAIC` and dredging, however you should first perform the backwards selection manually.** 

```{r, "Performing stepAIC backwards selection"}
options(na.action = "na.fail")
backwards_selection_native <- stepAIC(native_mod, direction = "backward")
backwards_selection_nonnative <- stepAIC(non_native_mod, direction = "backward")
```
```{r, "Performing Dredging"}
dredged_model_native <- dredge(native_mod, beta = "sd")
dredged_model_nonnative <- dredge(native_mod, beta = "sd")

head(dredged_model_native)
head(dredged_model_nonnative)
```

### Question 13

**Compare larger and smaller models using likelihood-ratio tests implemented as shown in the self-tutorials.**

```{r, "Performing Likelihood Tests"}
lrtest(native_mod, native_mod_2, native_mod_3)
lrtest(non_native_mod, non_native_mod_2, non_native_mod_3)
```

### Question 14

**Determine the relative strength of the predictors using a graph that shows how well the observed data fit the MAM predictions.**

```{r, "Plotting Strength of Predictors for the Native Model"}
native_plot_1 <- qplot(
  x = predict(native_mod), 
  y = ntv.rich, 
  data = mutated_data
) +
  xlab("Predicted (Original Native Model)") +
  ylab("")

native_plot_2 <- qplot(
  x = predict(native_mod_2), 
  y = ntv.rich, 
  data = mutated_data
) +
  xlab("Predicted (Native Model without Log-adjusted Elevation)") +
  ylab("")

native_plot_3 <- qplot(
  x = predict(native_mod_3), 
  y = ntv.rich, 
  data = mutated_data
) +
  xlab("Predicted (Native Model without Log-adjusted Elevation and Distance)") +
  ylab("")

native_plot <- ggarrange(
  native_plot_1, native_plot_2, native_plot_3, 
  nrow = 3, ncol = 1
) %>%
  annotate_figure(
    left = "Observed Values",
    top = "Q-Plot of Predicted Native Model Values", 
  )

plot(native_plot)
```
**Fig. 1** Q-Plot of predicted values for native plants (x-axis) versus actual, observed, values across three model types. Top: Predicted values for a linear model with log-adjusted area, log-adjusted elevation, and distance from mainland as predictors. Middle: Predicted values for a linear model with log-adjusted area and distance from mainland as predictors. Bottom: Predicted values for a linear model with distance from mainland as a predictor.

```{r, "Plotting Strength of Predictors for the Non-Native Model"}
non_native_plot_1 <- qplot(
  x = predict(non_native_mod), 
  y = ntv.rich, 
  data = mutated_data
) +
  xlab("Predicted (Original Non-Native Model)") +
  ylab("")

non_native_plot_2 <- qplot(
  x = predict(non_native_mod_2), 
  y = ntv.rich, 
  data = mutated_data
) +
  xlab("Predicted (Non-Native Model without Log-adjusted Elevation)") +
  ylab("")

non_native_plot_3 <- qplot(
  x = predict(non_native_mod_3), 
  y = ntv.rich, 
  data = mutated_data
) +
  xlab("Predicted (Non-Native Model without Log-adjusted Elevation and Distance)") +
  ylab("")


non_native_plot <- ggarrange(
  non_native_plot_1, non_native_plot_2, non_native_plot_3,  
  nrow = 3, ncol = 1
) %>%
  annotate_figure(
    left = "Observed Values",
    top = "Q-Plot of Predicted Non-Native Model Values" 
  )

plot(non_native_plot)
```
**Fig. 2** Q-Plot of predicted values for non-native plants (x-axis) versus actual, observed, values across three model types. Top: Predicted values for a linear model with log-adjusted area, log-adjusted elevation, and distance from mainland as predictors. Middle: Predicted values for a linear model with log-adjusted area and distance from mainland as predictors. Bottom: Predicted values for a linear model with distance from mainland as a predictor.


### Question 15

**Perform forward selection using the methods covered in the self-tutorial.**

```{r, "Performing Forwards Selection"}
forwards_selection_native <- stepAIC(native_mod, direction = "forward")
forwards_selection_nonnative <- stepAIC(non_native_mod, direction = "forward")

summary(forwards_selection_native)
summary(forwards_selection_nonnative)
```

### Question 16

For the native plants, we observe the following results for all three models:

| Model              | R^2    | LRT     | AIC      |
|--------------------|--------|---------|----------|
| 1 (Original)       | 0.8386 | -126.37 | 262.7385 |
| 2 (-`log_evel`)    | 0.8497 | -125.47 | 258.9444 |
| 3 (-`dist.mnland`) | 0.8397 | -127.45 | 260.9084 |

For non-native plants we observe the following: 

| Model              | R^2    | LRT     | AIC      |
|--------------------|--------|---------|----------|
| 1 (Original)       | 0.7121 | -125.47 | 260.9384 |
| 2 (-`log_evel`)    | 0.7272 | -125.47 | 258.9444 |
| 3 (-`dist.mnland`) | 0.7403 | -125.49 | 256.987  |


For the dredging results, we find that the highest performing model for native plants is `ntv.rick ~ log_area + log_elev + dist.mnland` and for non-native results it is `ntv.rich ~ log_area + dist.mnland` with AIC scores of 198.31 and 196.33 respectively. 

The MAM results do not directly match the dredging results: our manual backwards selection shows `ntv.rick ~ log_area + dist.mnland` and `ntv.rich ~ log_area` as being the highest performing. These results match with those gained from an LRT test, which show the largest negative values for the models mentioned above. While these are different, ANOVA tests show that the models do not significantly differ from one other—meaning that all three models are about as equally predictive. 





